@{
    ViewData["Title"] = "Gi·ªè h√†ng c·ªßa b·∫°n";
    Layout = "_Layout";
}

<style>
    .cart-item-row {
        border-bottom: 1px solid #eee;
        padding-top: 1.5rem;
        padding-bottom: 1.5rem;
    }
    .cart-product-image { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
    .quantity-input { width: 70px; text-align: center; }
    .remove-btn { color: #dc3545; cursor: pointer; font-size: 0.9rem; }
    .remove-btn:hover { text-decoration: underline; }
</style>

<div class="container mt-4 mb-5">
    <h1 class="mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h1>

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 d-flex align-items-center">
                    <div class="form-check me-3">
                        <input class="form-check-input" type="checkbox" id="select-all-checkbox">
                    </div>
                    <h5 class="mb-0">Ch·ªçn t·∫•t c·∫£ s·∫£n ph·∫©m</h5>
                </div>
                <div class="card-body" id="cart-items-container">
                    
                    <div id="cart-empty-message" style="display: none;">
                        <p class="text-center text-muted p-4">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>
                        <div class="text-center">
                            <a href="/" class="btn btn-primary">Ti·∫øp t·ª•c mua s·∫Øm</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">T·ªïng k·∫øt</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>T·∫°m t√≠nh</span>
                        <strong id="subtotal-price">0 ƒë</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                        <strong>Mi·ªÖn ph√≠</strong>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold fs-5">
                        <span>T·ªïng c·ªông</span>
                        <span class="text-danger" id="total-price">0 ƒë</span>
                    </div>
                    
                    <div class="d-grid mt-4">
                        <button class="btn btn-danger btn-lg" id="checkout-btn" onclick="proceedToCheckout()">
                            Ti·∫øn h√†nh thanh to√°n
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            const cartContainer = document.getElementById('cart-items-container');
            const subtotalPriceEl = document.getElementById('subtotal-price');
            const totalPriceEl = document.getElementById('total-price');
            const emptyCartMessage = document.getElementById('cart-empty-message');
            const checkoutBtn = document.getElementById('checkout-btn');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');

            // H√†m ch√≠nh: ƒê·ªçc 'myCart' v√† v·∫Ω l·∫°i to√†n b·ªô gi·ªè h√†ng
            function renderCart() {
                let cart = JSON.parse(localStorage.getItem('myCart')) || [];
                cartContainer.innerHTML = ''; 
                
                if (cart.length === 0) {
                    emptyCartMessage.style.display = 'block';
                    checkoutBtn.disabled = true; 
                    selectAllCheckbox.disabled = true;
                } else {
                    emptyCartMessage.style.display = 'none';
                    checkoutBtn.disabled = false;
                    selectAllCheckbox.disabled = false;
                    selectAllCheckbox.checked = true; // M·∫∑c ƒë·ªãnh ch·ªçn t·∫•t c·∫£

                    // 2. L·∫∑p qua s·∫£n ph·∫©m v√† t·∫°o HTML
                    cart.forEach(item => {
                        const itemHtml = `
                            <div class="d-flex align-items-center cart-item-row" data-cart-id="${item.cartItemId}">
                                <div class="form-check me-3">
                                    <input class="form-check-input item-checkbox" type="checkbox" value="${item.cartItemId}" checked>
                                </div>
                                
                                <img src="${item.image}" alt="${item.name}" class="cart-product-image me-3" />
                                
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">${item.name}</h6>
                                    <small class="text-muted">Ph√¢n lo·∫°i: ${item.variantName}</small>
                                    <p class="mb-0 fw-bold text-danger" data-price="${item.price}">${item.price.toLocaleString('vi-VN')} ƒë</p>
                                </div>
                                
                                <div class="px-3">
                                    <input type="number" class="form-control quantity-input" value="${item.quantity}" min="1" 
                                           onchange="updateQuantity('${item.cartItemId}', this.value)">
                                </div>
                                
                                <div class="text-end" style="width: 120px;">
                                    <span class="fw-bold item-total-price">0 ƒë</span>
                                </div>
                                
                                <div class="ms-3">
                                    <span class="remove-btn" onclick="removeItem('${item.cartItemId}')">X√≥a</span>
                                </div>
                            </div>
                        `;
                        cartContainer.insertAdjacentHTML('beforeend', itemHtml);
                    });
                }
                
                // 3. T√≠nh to√°n l·∫°i t·ªïng ti·ªÅn (d·ª±a tr√™n checkbox)
                recalculateTotals();
                addCheckboxListeners();
            }

            // (M·ªöI) H√†m t√≠nh to√°n l·∫°i t·ªïng ti·ªÅn
            function recalculateTotals() {
                let subtotal = 0;
                let allChecked = true;
                
                document.querySelectorAll('.cart-item-row').forEach(row => {
                    const checkbox = row.querySelector('.item-checkbox');
                    const price = parseFloat(row.querySelector('[data-price]').dataset.price);
                    const quantity = parseInt(row.querySelector('.quantity-input').value);
                    const itemTotalEl = row.querySelector('.item-total-price');
                    
                    let itemTotal = price * quantity;
                    itemTotalEl.textContent = itemTotal.toLocaleString('vi-VN') + ' ƒë';

                    if (checkbox.checked) {
                        subtotal += itemTotal;
                    } else {
                        allChecked = false; // N·∫øu 1 c√°i b·ªã b·ªè ch·ªçn, "Ch·ªçn t·∫•t c·∫£" s·∫Ω t·∫Øt
                    }
                });

                // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
                subtotalPriceEl.textContent = subtotal.toLocaleString('vi-VN') + ' ƒë';
                totalPriceEl.textContent = subtotal.toLocaleString('vi-VN') + ' ƒë';
                
                // C·∫≠p nh·∫≠t n√∫t "Ch·ªçn t·∫•t c·∫£"
                selectAllCheckbox.checked = allChecked;

                // T·∫Øt/m·ªü n√∫t thanh to√°n
                checkoutBtn.disabled = (subtotal === 0);
            }

            // (M·ªöI) H√†m g√°n s·ª± ki·ªán cho c√°c checkbox
            function addCheckboxListeners() {
                // Khi click "Ch·ªçn t·∫•t c·∫£"
                selectAllCheckbox.addEventListener('change', function() {
                    document.querySelectorAll('.item-checkbox').forEach(cb => {
                        cb.checked = selectAllCheckbox.checked;
                    });
                    recalculateTotals();
                });

                // Khi click checkbox c·ªßa t·ª´ng item
                document.querySelectorAll('.item-checkbox').forEach(cb => {
                    cb.addEventListener('change', recalculateTotals);
                });
            }

            // H√†m c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng (S·ª≠a ƒë·ªïi ƒë·ªÉ g·ªçi recalculateTotals)
            window.updateQuantity = function(cartItemId, newQuantity) {
                let cart = JSON.parse(localStorage.getItem('myCart')) || [];
                let item = cart.find(i => i.cartItemId === cartItemId);
                
                if (item) {
                    item.quantity = parseInt(newQuantity);
                    if (item.quantity <= 0) item.quantity = 1; 
                }
                
                localStorage.setItem('myCart', JSON.stringify(cart));
               
                recalculateTotals(); 
                
            }

            
            window.removeItem = function(cartItemId) {
                if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?")) return;
                
                let cart = JSON.parse(localStorage.getItem('myCart')) || [];
                cart = cart.filter(i => i.cartItemId !== cartItemId);
                
                localStorage.setItem('myCart', JSON.stringify(cart));
                renderCart(); // Ph·∫£i v·∫Ω l·∫°i t·ª´ ƒë·∫ßu
                window.dispatchEvent(new Event('cartUpdated')); // B√°o cho _Layout c·∫≠p nh·∫≠t badge
            }

            // (M·ªöI) H√†m ch·∫°y khi nh·∫•n "Ti·∫øn h√†nh thanh to√°n"
            window.proceedToCheckout = function() {
                let fullCart = JSON.parse(localStorage.getItem('myCart')) || [];
                let selectedItems = [];

                // 1. L·∫•y ID c·ªßa c√°c item ƒë√£ ƒë∆∞·ª£c check
                document.querySelectorAll('.item-checkbox:checked').forEach(cb => {
                    const cartItemId = cb.value;
                    const item = fullCart.find(i => i.cartItemId === cartItemId);
                    if (item) {
                        // (Quan tr·ªçng) L·∫•y s·ªë l∆∞·ª£ng m·ªõi nh·∫•t t·ª´ √¥ input
                        const row = cb.closest('.cart-item-row');
                        const quantity = parseInt(row.querySelector('.quantity-input').value);
                        item.quantity = quantity; // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
                        
                        selectedItems.push(item);
                    }
                });

                // 2. L∆∞u danh s√°ch ƒë√£ l·ªçc v√†o key m·ªõi
sessionStorage.setItem('checkoutCart', JSON.stringify(selectedItems));
                
                // 3. Chuy·ªÉn sang trang Thanh to√°n
                window.location.href = '/Checkout';
            }

            // Ch·∫°y l·∫ßn ƒë·∫ßu khi t·∫£i trang
            renderCart();
        });
    </script>
}