@model asp_project.ViewModels.ShopInventoryViewModel
@{
    ViewData["Title"] = "Quản lý Kho hàng";
    Layout = "_StoreLayout";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
        <h1 class="h3 mb-0 text-primary fw-bold">
            <i class="bi bi-box-seam me-2"></i>Nhập kho
        </h1>
        <div class="d-flex gap-2 flex-wrap">
            <input type="text" id="searchProduct" class="form-control form-control-sm" placeholder="Tìm sản phẩm..." style="width: 250px;">
            <a asp-action="ExportToExcel" class="btn btn-success btn-sm">
                <i class="bi bi-file-earmark-excel-fill"></i> Xuất Excel
            </a>
        </div>
    </div>

    <!-- Alerts -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["InfoMessage"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            @TempData["InfoMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @Html.AntiForgeryToken()

    @if (!Model.Products.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <p class="mt-3 text-muted fs-5">Bạn chưa có sản phẩm nào.</p>
        </div>
    }
    else
    {
        <!-- Accordion chứa từng sản phẩm -->
        <div class="accordion" id="productsAccordion">
            @for (int i = 0; i < Model.Products.Count; i++)
            {
                var product = Model.Products[i];
                var collapseId = $"collapseProduct{i}";

                <div class="accordion-item shadow-sm mb-3 rounded overflow-hidden"
                     data-product-name="@product.ProductName.ToLower()"
                     data-product-id="@product.ProductId">

                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed fw-semibold text-dark fs-5" type="button"
                                data-bs-toggle="collapse" data-bs-target="#@(collapseId)">
                            @product.ProductName
                            <span class="badge bg-primary ms-auto">@product.Skus.Count phân loại</span>
                        </button>
                    </h2>

                    <div id="@(collapseId)" class="accordion-collapse collapse" data-bs-parent="#productsAccordion">
                        <div class="accordion-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 80px;">Ảnh</th>
                                            <th>Phân loại</th>
                                            <th class="text-center">Tồn kho</th>
                                            <th class="text-center">Thêm số lượng</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (int j = 0; j < product.Skus.Count; j++)
                                        {
                                            var sku = product.Skus[j];
                                            <tr class="sku-row">
                                                <td>
                                                    <img src="@sku.ImageUrl"
                                                         class="rounded shadow-sm"
                                                         style="width:60px;height:60px;object-fit:cover;"
                                                         alt="Ảnh sản phẩm">
                                                </td>
                                                <td>
                                                    <input type="hidden" class="sku-code" value="@sku.SkuCode" />
                                                    <strong>@sku.SkuName</strong>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-secondary fs-6 px-3 py-2">@sku.TonKho</span>
                                                </td>
                                                <td class="text-center">
                                                    <div class="input-group input-group-sm" style="width: 130px; margin: 0 auto;">
                                                        <button class="btn btn-outline-secondary btn-minus" type="button">-</button>
                                                        <input type="number"
                                                               class="form-control text-center stock-add-input"
                                                               min="0" value="0" />
                                                        <button class="btn btn-outline-secondary btn-plus" type="button">+</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Nút cố định dưới cùng (mobile) -->
    <div class="position-fixed bottom-0 start-50 translate-middle-x w-100 p-3" style="z-index: 1050; max-width: 500px;">
        <button type="button" class="btn btn-primary btn-lg w-100 shadow-lg rounded-pill" id="update-stock-btn">
            <i class="bi bi-box-arrow-in-down"></i> Cập nhật Kho
        </button>
    </div>
    <div class="pb-5"></div> <!-- Khoảng trống để không bị che -->
</div>

@section Scripts {
    <script>
        // Tìm kiếm sản phẩm
        document.getElementById('searchProduct').addEventListener('input', function (e) {
            const term = e.target.value.toLowerCase().trim();
            document.querySelectorAll('.accordion-item').forEach(item => {
                const name = item.dataset.productName;
                item.style.display = name.includes(term) ? '' : 'none';
            });
        });

        // Nút + / -
        document.querySelectorAll('.btn-plus').forEach(btn => {
            btn.addEventListener('click', () => {
                const input = btn.closest('.input-group').querySelector('.stock-add-input');
                input.value = parseInt(input.value || 0) + 1;
            });
        });

        document.querySelectorAll('.btn-minus').forEach(btn => {
            btn.addEventListener('click', () => {
                const input = btn.closest('.input-group').querySelector('.stock-add-input');
                const val = parseInt(input.value || 0);
                if (val > 0) input.value = val - 1;
            });
        });

        // Submit cập nhật kho
        async function submitStockUpdate() {
            const btn = document.getElementById('update-stock-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Đang cập nhật...';

            const productsToUpdate = [];

            document.querySelectorAll('.accordion-item').forEach(item => {
                const productId = item.dataset.productId;
                const skusToUpdate = [];

                item.querySelectorAll('.sku-row').forEach(row => {
                    const input = row.querySelector('.stock-add-input');
                    const soLuongThem = parseInt(input.value) || 0;

                    if (soLuongThem > 0) {
                        const skuCode = row.querySelector('.sku-code').value;
                        skusToUpdate.push({
                            SkuCode: skuCode,
                            SoLuongThem: soLuongThem
                        });
                    }
                });

                if (skusToUpdate.length > 0) {
                    productsToUpdate.push({
                        ProductId: productId,
                        Skus: skusToUpdate
                    });
                }
            });

            if (productsToUpdate.length === 0) {
                alert('Bạn chưa nhập số lượng thêm nào!');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-box-arrow-in-down"></i> Cập nhật Kho';
                return;
            }

            const viewModel = { Products: productsToUpdate };
            console.log('Dữ liệu gửi đi:', viewModel);

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const response = await fetch('/ShopInventory/Index', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify(viewModel)
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    const err = await response.json();
                    alert('Lỗi: ' + (err.message || 'Không xác định'));
                }
            } catch (err) {
                console.error(err);
                alert('Lỗi kết nối mạng. Vui lòng thử lại.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-box-arrow-in-down"></i> Cập nhật Kho';
            }
        }

        // Gắn sự kiện cho nút (đã onclick trong HTML, nhưng để chắc chắn)
        document.getElementById('update-stock-btn').addEventListener('click', submitStockUpdate);
    </script>
}