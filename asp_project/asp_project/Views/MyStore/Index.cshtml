@{
    ViewData["Title"] = "Thống kê cửa hàng";
    var defaultEndDate = DateTime.UtcNow.ToString("yyyy-MM-dd");
    var defaultStartDate = DateTime.UtcNow.AddDays(-6).ToString("yyyy-MM-dd");
}

<div class="container mt-4">
    <h1 class="mb-4">Thống kê cửa hàng</h1>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-5">
                    <label for="startDate" class="form-label">Từ ngày</label>
                    <input type="date" id="startDate" class="form-control" value="@defaultStartDate">
                </div>
                <div class="col-md-5">
                    <label for="endDate" class="form-label">Đến ngày</label>
                    <input type="date" id="endDate" class="form-control" value="@defaultEndDate">
                </div>
                <div class="col-md-2 d-grid">
                    <button id="filterButton" class="btn btn-primary">Lọc</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-danger mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">⚠️ Cảnh báo: Sản phẩm sắp hết hàng (dưới 5)</h5>
        </div>
        <div class="card-body p-0">
            <div id="low-stock-container" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Tên sản phẩm</th>
                            <th>Mã SKU (Phân loại)</th>
                            <th class="text-end">Chỉ còn</th>
                        </tr>
                    </thead>
                    <tbody id="low-stock-table-body">
                        </tbody>
                </table>
            </div>
            <div id="low-stock-placeholder" class="text-center text-muted p-3" style="display: none;">
                <i class="bi bi-check-circle-fill text-success"></i> Tuyệt vời! Không có sản phẩm nào sắp hết hàng.
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">CHỜ XỬ LÝ (Pending)</h6>
                    <h2 class="card-title text-warning" id="kpi-pending">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">ĐANG GIAO (Shipping)</h6>
                    <h2 class="card-title text-info" id="kpi-shipping">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">ĐÃ GIAO (Tổng)</h6>
                    <h2 class="card-title text-success" id="kpi-delivered">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">ĐÃ HỦY (Cancelled)</h6>
                    <h2 class="card-title text-danger" id="kpi-cancelled">0</h2>
                </div>
            </div>
        </div>
    </div>

    <hr class="mb-4">
    
    <p class="text-center text-muted">
        Biểu đồ hiển thị doanh thu & đơn hàng <span class="badge bg-success">Đã giao</span>
        trong khoảng thời gian đã chọn.
    </p>

    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">TỔNG DOANH THU (Đã giao, theo ngày)</h6>
                    <h2 class="card-title text-success" id="kpi-revenue">0 đ</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-body text-center">
                    <h6 class="card-subtitle mb-2 text-muted">TỔNG ĐƠN HÀNG (Đã giao, theo ngày)</h6>
                    <h2 class="card-title text-primary" id="kpi-orders">0</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3"> Doanh thu (VNĐ) </div>
                <div class="card-body"> <canvas id="revenueChart"></canvas> </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3"> Số lượng đơn hàng </div>
                <div class="card-body"> <canvas id="ordersChart"></canvas> </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let revenueChartInstance = null;
        let ordersChartInstance = null;

        // Lấy các phần tử KPI
        const startDateEl = document.getElementById('startDate');
        const endDateEl = document.getElementById('endDate');
        const filterButton = document.getElementById('filterButton');
        const kpiRevenueEl = document.getElementById('kpi-revenue');
        const kpiOrdersEl = document.getElementById('kpi-orders');
        const kpiPendingEl = document.getElementById('kpi-pending');
        const kpiShippingEl = document.getElementById('kpi-shipping');
        const kpiDeliveredEl = document.getElementById('kpi-delivered');
        const kpiCancelledEl = document.getElementById('kpi-cancelled');

        // (MỚI) Lấy phần tử của bảng cảnh báo
        const lowStockTableBody = document.getElementById('low-stock-table-body');
        const lowStockPlaceholder = document.getElementById('low-stock-placeholder');
        const lowStockContainer = document.getElementById('low-stock-container');

        async function fetchAndRenderCharts() {
            const startDate = startDateEl.value;
            const endDate = endDateEl.value;

            filterButton.disabled = true;
            filterButton.textContent = 'Đang tải...';

            try {
                const response = await fetch(`/MyStore/GetDashboardStats?startDate=${startDate}&endDate=${endDate}`);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Không thể tải dữ liệu thống kê.');
                }
                
                const data = await response.json();
                console.log("Dữ liệu nhận được:", data);

                // --- 1. CẬP NHẬT THẺ KPI (Trạng thái) ---
                kpiPendingEl.textContent = (data.statusCounts.Pending || 0).toLocaleString('vi-VN');
                kpiShippingEl.textContent = (data.statusCounts.Shipping || 0).toLocaleString('vi-VN');
                kpiDeliveredEl.textContent = (data.statusCounts.Delivered || 0).toLocaleString('vi-VN');
                kpiCancelledEl.textContent = (data.statusCounts.Cancelled || 0).toLocaleString('vi-VN');

                // --- 2. CẬP NHẬT THẺ KPI (Doanh thu theo ngày) ---
                kpiRevenueEl.textContent = data.overallRevenue.toLocaleString('vi-VN') + ' đ';
                kpiOrdersEl.textContent = data.overallOrders.toLocaleString('vi-VN');

                // --- 3. (MỚI) CẬP NHẬT BẢNG CẢNH BÁO HẾT HÀNG ---
                lowStockTableBody.innerHTML = ''; // Xóa nội dung cũ
                if (data.lowStockItems && data.lowStockItems.length > 0) {
                    lowStockContainer.style.display = 'block';
                    lowStockPlaceholder.style.display = 'none';
                    
                    data.lowStockItems.forEach(item => {
                        const row = `
                            <tr>
                                <td class="py-2">
                                    <div>${item.productName}</div>
                                </td>
                                <td class="py-2">${item.skuCode}</td>
                                <td class="py-2 text-end fw-bold text-danger">${item.stockLeft}</td>
                            </tr>
                        `;
                        lowStockTableBody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    // Không có sản phẩm nào sắp hết
                    lowStockContainer.style.display = 'none';
                    lowStockPlaceholder.style.display = 'block';
                }

                // --- 4. VẼ BIỂU ĐỒ (Giữ nguyên) ---
                if (revenueChartInstance) revenueChartInstance.destroy();
                if (ordersChartInstance) ordersChartInstance.destroy();

                const ctxRevenue = document.getElementById('revenueChart').getContext('2d');
                revenueChartInstance = new Chart(ctxRevenue, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Doanh thu',
                            data: data.revenueData,
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 2, fill: true, tension: 0.1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });

                const ctxOrders = document.getElementById('ordersChart').getContext('2d');
                ordersChartInstance = new Chart(ctxOrders, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Số đơn hàng',
                            data: data.orderData,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });

            } catch (error) {
                console.error('Lỗi khi vẽ biểu đồ:', error);
                alert('Lỗi: ' + error.message);
            } finally {
                filterButton.disabled = false;
                filterButton.textContent = 'Lọc';
            }
        }

        filterButton.addEventListener('click', fetchAndRenderCharts);
        document.addEventListener('DOMContentLoaded', fetchAndRenderCharts);
    </script>
}